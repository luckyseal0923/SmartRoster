<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç­è¡¨ç¢ºèª</title>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 16px;
    color: #1f2937;
  }

  .container {
    max-width: 640px;
    margin: 0 auto;
  }

  .card {
    background: #fff;
    border-radius: 14px;
    padding: 20px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    margin-bottom: 16px;
  }

  h2 {
    margin: 0 0 12px;
    text-align: center;
  }

  h3 {
    margin: 0 0 12px;
    font-size: 16px;
    color: #374151;
  }

  /* ===== æŸ¥è©¢åˆ— ===== */
  .search-row {
    display: flex;
    gap: 8px;
  }

  .search-row input {
    flex: 1;
    padding: 12px;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid #d1d5db;
  }

  .search-row button {
    padding: 12px 18px;
    font-size: 15px;
    border-radius: 10px;
    border: none;
    background: #2563eb;
    color: white;
    font-weight: 600;
  }

  /* ===== äººå“¡è³‡è¨Š ===== */
  .info-grid {
    display: grid;
    grid-template-columns: 80px 1fr;
    row-gap: 8px;
    column-gap: 12px;
    font-size: 15px;
  }

  .info-label {
    color: #6b7280;
  }

  /* ===== ç­è¡¨è¡¨æ ¼ ===== */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 15px;
  }

  thead {
    background: #f1f5f9;
  }

  th, td {
    padding: 10px;
    border-bottom: 1px solid #e5e7eb;
    text-align: center;
  }

  th {
    font-weight: 600;
    color: #374151;
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  /* ===== ç°½æ ¸æŒ‰éˆ• ===== */
  .action-btn {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    border-radius: 12px;
    border: none;
    background: #16a34a;
    color: white;
    font-weight: 700;
  }

  .hidden {
    display: none;
  }
</style>
</head>

<body>

<div class="container">

  <!-- æŸ¥è©¢ -->
  <div class="card">
    <h2>ç­è¡¨ç¢ºèª</h2>
<div id="taskDisplay" style="text-align: center; color: var(--muted); font-size: 13px; margin-bottom: 12px;">
  ä»»å‹™è¼‰å…¥ä¸­...
</div>
    <div class="search-row">
      <input id="staffId" placeholder="è«‹è¼¸å…¥å“¡ç·¨" />
      <button onclick="lookup()">æŸ¥è©¢ç­è¡¨</button>
    </div>
  </div>

  <!-- æŸ¥è©¢çµæœ -->
  <div class="card hidden" id="resultCard">

    <!-- äººå“¡è³‡è¨Š -->
    <h3>ç°½æ ¸äººè³‡æ–™</h3>
    <div class="info-grid">
      <div class="info-label">å§“å</div>
      <div id="name"></div>
      <div class="info-label">å“¡ç·¨</div>
      <div id="staff"></div>
    </div>

    <!-- ç­è¡¨ -->
    <h3 style="margin-top:16px;">ç­è¡¨å…§å®¹</h3>
    <table>
      <thead>
        <tr>
          <th>æ—¥æœŸ</th>
          <th>ç­åˆ¥</th>
          <th>å‚™è¨»</th>
        </tr>
      </thead>
      <tbody id="scheduleTable"></tbody>
    </table>

    <button class="action-btn" onclick="goSign()">
      ç¢ºèªä¸¦ç°½æ ¸
    </button>
  </div>

</div>

<script>
// ğŸ“ 1. æŠ“å– URL ä¸­çš„ task_id (ä¾‹å¦‚ï¼šconfirm.html?id=task-202603-XXX)
const urlParams = new URLSearchParams(window.location.search);
const taskId = urlParams.get('id');

let currentStaffId = "";

// ğŸ“ 2. é é¢è¼‰å…¥æª¢æŸ¥
window.onload = function() {
  const display = document.getElementById("taskDisplay");
  if (taskId) {
    display.innerText = `ä»»å‹™ç·¨è™Ÿï¼š${taskId}`;
  } else {
    display.innerHTML = "<b style='color:red;'>éŒ¯èª¤ï¼šç¼ºå°‘ä»»å‹™ IDï¼Œè«‹æ´½å–®ä½ä¸»ç®¡ã€‚</b>";
    document.querySelector(".search-row button").disabled = true;
  }
};

// ğŸ“ 3. æŸ¥è©¢ç­è¡¨å‡½æ•¸
async function lookup() {
  const staffIdInput = document.getElementById("staffId").value.trim();
  if (!staffIdInput) return alert("è«‹è¼¸å…¥å“¡ç·¨");

  const btn = document.querySelector(".search-row button");
  btn.innerText = "æŸ¥è©¢ä¸­...";
  btn.disabled = true;

  try {
    // ğŸ“ å‘¼å« n8n æŸ¥è©¢è©²ä»»å‹™ä¸­è©²å“¡ç·¨çš„ç­è¡¨
// ğŸ“ è«‹æ³¨æ„è·¯å¾‘å·²æ”¹ç‚º Staff-check-roster
const res = await fetch(`https://chihwei-n8n.zeabur.app/webhook/Staff-check-roster`);
    if (!res.ok) throw new Error("æŸ¥ç„¡æ­¤å“¡ç·¨æˆ–ä»»å‹™å·²éæœŸ");

    let record = await res.json(); 

    // ğŸ“ é—œéµä¿®æ­£ï¼šå¦‚æœ n8n å‚³å›çš„æ˜¯ [ { ... } ] é™£åˆ—æ ¼å¼ï¼Œè‡ªå‹•å–ç¬¬ä¸€ç­†
    if (Array.isArray(record)) {
        record = record[0];
    }

    // ğŸ“ é—œéµä¿®æ­£ï¼šå°‡ scheduleString å­—ä¸²è§£æå› Array
    let scheduleArray = [];
    try {
        scheduleArray = typeof record.scheduleString === 'string' 
            ? JSON.parse(record.scheduleString) 
            : record.schedule;
    } catch (e) {
        console.error("è§£æç­è¡¨å¤±æ•—", e);
    }

const record = await res.json();
currentStaffId = staffIdInput;
document.getElementById("name").innerText = record.name || "æœªå®šç¾©";
document.getElementById("staff").innerText = record.staff_id || staffIdInput;

const tbody = document.getElementById("scheduleTable");
tbody.innerHTML = "";

if (Array.isArray(record.schedule) && record.schedule.length > 0) {
  record.schedule.forEach(entry => {
    tbody.innerHTML += `
      <tr>
        <td>${entry.date}</td>
        <td>${entry.shift}</td>
        <td>${entry.note || "-"}</td>
      </tr>`;
  });
} else {
  tbody.innerHTML = "<tr><td colspan='3'>å°šç„¡ç­è¡¨è³‡æ–™</td></tr>";
}

    document.getElementById("resultCard").classList.remove("hidden");
  } finally {
    btn.innerText = "æŸ¥è©¢ç­è¡¨";
    btn.disabled = false;
  }
}

// ğŸ“ 4. å‰å¾€ç°½æ ¸é é¢
function goSign() {
  if (!currentStaffId || !taskId) return alert("è³‡æ–™ä¸å®Œæ•´");
  // å¸¶è‘— ID å‰å¾€ç°½åé 
  location.href = `sign.html?id=${taskId}&staffId=${encodeURIComponent(currentStaffId)}`;
}
</script>

</body>
</html>
