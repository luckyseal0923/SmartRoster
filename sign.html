<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>手寫簽名</title>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
    background: #fff;
    margin: 0;
    padding: 16px;
  }

  h2 {
    text-align: center;
    margin: 0 0 8px;
  }

  .hint {
    text-align: center;
    color: #555;
    margin-bottom: 12px;
    font-size: 14px;
  }

  canvas {
    width: 100%;
    height: 220px;
    border: 2px dashed #cbd5e1;
    border-radius: 8px;
    touch-action: none;
    background: #fff;
    display: block;
  }

  button {
    width: 100%;
    margin-top: 12px;
    padding: 14px;
    font-size: 16px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    cursor: pointer;
  }

  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .primary {
    background: #2563eb;
    color: white;
  }

  .secondary {
    background: #e5e7eb;
    color: #111;
  }
</style>
</head>

<body>

<h2>簽核確認</h2>
<div class="hint" id="taskHint"></div>
<div class="hint" id="staffHint"></div>

<canvas id="signature"></canvas>

<button class="secondary" id="clearBtn" onclick="clearCanvas()">清除簽名</button>
<button class="primary" id="submitBtn" onclick="submitSignature()">送出簽核</button>

<script>
  /* ===== 讀取網址參數 ===== */
  const params = new URLSearchParams(location.search);
  const taskId = params.get("id");
  const staffId = params.get("staffId");

  const taskHint = document.getElementById("taskHint");
  const staffHint = document.getElementById("staffHint");

  taskHint.innerText = taskId ? `任務編號：${taskId}` : "⚠️ 缺少任務編號";
  staffHint.innerText = staffId ? `員編：${staffId}` : "⚠️ 未提供員編";

  const submitBtn = document.getElementById("submitBtn");
  const clearBtn = document.getElementById("clearBtn");

  /* ===== Canvas 設定 ===== */
  const canvas = document.getElementById("signature");
  const ctx = canvas.getContext("2d");

  let drawing = false;

  function setupCanvas() {
    const rect = canvas.getBoundingClientRect();
    const ratio = window.devicePixelRatio || 1;

    canvas.width = rect.width * ratio;
    canvas.height = rect.height * ratio;

    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
  }

  setupCanvas();
  window.addEventListener("resize", setupCanvas);

  function getPoint(e) {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : e;
    return {
      x: touch.clientX - rect.left,
      y: touch.clientY - rect.top
    };
  }

  function startDraw(e) {
    drawing = true;
    const p = getPoint(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
    e.preventDefault();
  }

  function draw(e) {
    if (!drawing) return;
    const p = getPoint(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    e.preventDefault();
  }

  function endDraw() {
    drawing = false;
  }

  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", endDraw);
  canvas.addEventListener("mouseleave", endDraw);

  canvas.addEventListener("touchstart", startDraw, { passive: false });
  canvas.addEventListener("touchmove", draw, { passive: false });
  canvas.addEventListener("touchend", endDraw);

  function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  function isCanvasBlank() {
    const blank = document.createElement("canvas");
    blank.width = canvas.width;
    blank.height = canvas.height;
    return canvas.toDataURL() === blank.toDataURL();
  }

  async function submitSignature() {
    if (!taskId || !staffId) {
      alert("缺少任務或員編資訊，請從正確連結進入。");
      return;
    }

    if (isCanvasBlank()) {
      alert("請先簽名");
      return;
    }

    const signatureData = canvas.toDataURL("image/png");

    submitBtn.disabled = true;
    clearBtn.disabled = true;
    submitBtn.textContent = "上傳中...";

    try {
      const res = await fetch("https://chihwei-n8n.zeabur.app/webhook/sign-submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          taskId,
          staffId,
          signature: signatureData
        })
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || "簽核失敗");
      }

      const result = await res.json().catch(() => ({ status: "ok", message: "簽核完成" }));

      alert(result.message || "簽核完成");
      clearCanvas();
    } catch (err) {
      console.error(err);
      alert(err.message || "系統錯誤，請稍後再試");
    } finally {
      submitBtn.disabled = false;
      clearBtn.disabled = false;
      submitBtn.textContent = "送出簽核";
    }
  }
</script>

</body>
</html>
