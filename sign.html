<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>手寫簽名</title>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
    background: #fff;
    margin: 0;
    padding: 16px;
  }

  h2 {
    text-align: center;
    margin: 0 0 8px;
  }

  .hint {
    text-align: center;
    color: #555;
    margin-bottom: 12px;
    font-size: 14px;
  }

  canvas {
    width: 100%;
    height: 220px;          /* ✅ 固定顯示高度 */
    border: 2px dashed #cbd5e1;
    border-radius: 8px;
    touch-action: none;     /* ✅ 關鍵：避免頁面滑動 */
    background: #fff;
    display: block;
  }

  button {
    width: 100%;
    margin-top: 12px;
    padding: 14px;
    font-size: 16px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
  }

  .primary {
    background: #2563eb;
    color: white;
  }

  .secondary {
    background: #e5e7eb;
    color: #111;
  }
</style>
</head>

<body>

<h2>簽核確認</h2>
<div class="hint" id="staffHint"></div>

<canvas id="signature"></canvas>

<button class="secondary" onclick="clearCanvas()">清除簽名</button>
<button class="primary" onclick="submit()">送出簽核</button>

<script>
  /* ===== 讀取網址參數 ===== */
  const params = new URLSearchParams(location.search);
  const staffId = params.get("staffId");
  document.getElementById("staffHint").innerText =
    staffId ? `員編：${staffId}` : "未提供員編";

  /* ===== Canvas 設定 ===== */
  const canvas = document.getElementById("signature");
  const ctx = canvas.getContext("2d");

  let drawing = false;

  function setupCanvas() {
    const rect = canvas.getBoundingClientRect();
    const ratio = window.devicePixelRatio || 1;

    /* 實體像素大小 */
    canvas.width = rect.width * ratio;
    canvas.height = rect.height * ratio;

    /* 重設 transform，避免累積誤差 */
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
  }

  setupCanvas();
  window.addEventListener("resize", setupCanvas);

  function getPoint(e) {
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : e;
    return {
      x: touch.clientX - rect.left,
      y: touch.clientY - rect.top
    };
  }

  function startDraw(e) {
    drawing = true;
    const p = getPoint(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
    e.preventDefault();
  }

  function draw(e) {
    if (!drawing) return;
    const p = getPoint(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    e.preventDefault();
  }

  function endDraw() {
    drawing = false;
  }

  /* ===== 滑鼠 ===== */
  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", endDraw);
  canvas.addEventListener("mouseleave", endDraw);

  /* ===== 觸控 ===== */
  canvas.addEventListener("touchstart", startDraw, { passive: false });
  canvas.addEventListener("touchmove", draw, { passive: false });
  canvas.addEventListener("touchend", endDraw);

  function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  function submit() {
    const data = canvas.toDataURL("image/png");

    if (data.length < 2000) {
      alert("請先簽名");
      return;
    }

    console.log("staffId:", staffId);
    console.log("signature base64:", data);

    alert("簽核完成（模擬）");
  }
</script>

</body>
</html>
