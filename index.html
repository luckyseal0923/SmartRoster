<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>SmartRosterï½œæ™ºæ…§ç­è¡¨ç°½æ ¸ç³»çµ±</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root{
  --primary:#374151;      /* çŸ³å¢¨ç° */
  --accent:#059669;       /* é†«ç™‚ç¶  */
  --bg:#eef2f0;           /* æ·¡èƒŒæ™¯ */
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --ok:#059669;
  --warn:#b45309;
  --bad:#b91c1c;
}

body{
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",sans-serif;
  background:var(--bg);
  color:var(--text);
  margin:0;
  padding:32px;
}

.container{max-width:1200px;margin:auto;}

header{margin-bottom:32px;}
header h1{margin:0;font-size:30px;}
header p{margin-top:6px;color:var(--muted);}

.card{
  background:var(--card);
  border-radius:16px;
  padding:28px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
  margin-bottom:32px;
}

h3{margin-top:0;}

/* ===== è¡¨å–® ===== */
.form-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px 20px;
}

label{
  font-size:13px;
  color:var(--muted);
  margin-bottom:4px;
  display:block;
}

input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:14px;
}

.upload-box{
  margin-top:16px;
  border:2px dashed var(--border);
  border-radius:14px;
  padding:24px;
  text-align:center;
  background:#fafafa;
}

/* ===== æŒ‰éˆ• ===== */
.actions{
  display:flex;
  gap:16px;
  margin-top:24px;
}

button{
  padding:14px 20px;
  border-radius:12px;
  border:none;
  font-size:15px;
  cursor:pointer;
}

button.primary{background:var(--primary);color:#fff;}
button.accent{background:var(--accent);color:#fff;}
button:disabled{opacity:.5;cursor:not-allowed;}
  button.secondary{
  background:#f3f4f6;
  color:#374151;
  border:1px solid #d1d5db;
}

button.secondary:hover{
  background:#e5e7eb;
}

/* ===== ä»»å‹™æ¸…å–® table ===== */
table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:14px 12px;
  border-bottom:1px solid var(--border);
  font-size:14px;
  text-align:left;
}

th{color:var(--muted);font-weight:600;}

.progress{
  background:#e5e7eb;
  border-radius:999px;
  height:10px;
  overflow:hidden;
  margin-bottom:6px;
}

.progress-bar{
  background:var(--accent);
  height:100%;
}

.copy{cursor:pointer;font-size:18px;}

/* ===== Modal ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
}

.modal-box{
  background:#fff;
  border-radius:16px;
  padding:28px;
  width:440px;
  max-height:85vh;        /* âœ… æ–°å¢ */
  overflow:hidden;        /* âœ… æ–°å¢ */
}

.status-ok{color:var(--ok);}
.status-warn{color:var(--warn);}
.status-bad{color:var(--bad);
           }
  .file-btn{
  padding:10px 14px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#f9fafb;
  cursor:pointer;
  font-size:14px;
}

.file-btn:hover{
  background:#eef2f7;
}
</style>
</head>

<body>
<div class="container">

<header>
  <h1>SmartRoster</h1>
  <p>æ™ºæ…§ç­è¡¨ç°½æ ¸ç³»çµ±</p>
</header>

<!-- ===== å»ºç«‹æ–°ä»»å‹™ ===== -->
<div class="card">
  <h3>ğŸ“Œ å»ºç«‹æ–°ç°½æ ¸ä»»å‹™</h3>

  <div class="form-grid">
    <div>
      <label>ä»»å‹™å»ºç«‹è€…</label>
      <input id="creator">
    </div>

    <div>
      <label>å“¡å·¥ç·¨è™Ÿ</label>
      <input id="staffId">
    </div>

    <div>
      <label>å–®ä½åˆ¥</label>
      <input id="unit">
    </div>

    <div>
      <label>ç°½æ ¸æœˆä»½</label>
      <input id="month" type="month">
    </div>

    <div>
      <label>è¨­å®šå¯†ç¢¼ï¼ˆè‡³å°‘ 6 ç¢¼ï¼‰</label>
      <input id="password" type="password">
    </div>
  </div>

<div class="upload-box">
  <div style="font-size:18px;margin-bottom:8px;">
    ğŸ“ <strong>ä¸Šå‚³ç­è¡¨ Excel</strong>
  </div>

  <p style="color:var(--muted);margin-bottom:12px;">
    ç”¨æ–¼è¾¨è­˜å¾…ç°½æ ¸äººæ•¸
  </p>

  <div id="filePicker" style="display:flex;align-items:center;gap:10px;">
    <label for="fileInput" class="file-btn">
      â¬† é¸æ“‡æª”æ¡ˆ
    </label>
    <span id="fileName" style="color:#374151;"></span>
    <button id="clearFileBtn"
            onclick="clearFile()"
            style="display:none;border:none;background:none;color:#b91c1c;cursor:pointer;font-size:18px;">
      âœ–
    </button>
  </div>

  <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none;">
</div>

  <div class="actions">
    <button class="accent" onclick="runCheck()">ğŸ” æŸ¥æ ¸ä»»å‹™è¾¨è­˜</button>
  </div>
</div>

<!-- ===== ä»»å‹™æ¸…å–®ï¼ˆèˆŠåŠŸèƒ½å®Œæ•´ä¿ç•™ï¼‰ ===== -->
<div class="card">
  <h3>ğŸ“Š ä»»å‹™æ¸…å–®</h3>

  <table>
    <thead>
      <tr>
        <th>ä»»å‹™ç·¨ç¢¼</th>
        <th>å–®ä½</th>
        <th>æœˆä»½</th>
        <th>å®Œæˆåº¦</th>
        <th>é€£çµ</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>SHIFT-2026-001</td>
        <td>æ€¥è¨ºéƒ¨</td>
        <td>2026-02</td>
        <td>
          <div class="progress"><div class="progress-bar" style="width:80%"></div></div>
          80%
        </td>
        <td><span class="copy" onclick="copyLink()">ğŸ“‹</span></td>
      </tr>

      <tr>
        <td>SHIFT-2026-002</td>
        <td>å…§ç§‘</td>
        <td>2026-03</td>
        <td>
          <div class="progress"><div class="progress-bar" style="width:45%"></div></div>
          45%
        </td>
        <td><span class="copy" onclick="copyLink()">ğŸ“‹</span></td>
      </tr>

      <tr>
        <td>SHIFT-2026-003</td>
        <td>å¤–ç§‘</td>
        <td>2026-04</td>
        <td>
          <div class="progress"><div class="progress-bar" style="width:100%"></div></div>
          100%
        </td>
        <td><span class="copy" onclick="copyLink()">ğŸ“‹</span></td>
      </tr>
    </tbody>
  </table>
</div>

</div>

<!-- ===== æŸ¥æ ¸ Modalï¼ˆDemoï¼‰ ===== -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3>ğŸ” ä»»å‹™è¾¨è­˜çµæœ</h3>

    <!-- ç³»çµ±æŸ¥æ ¸ç‹€æ…‹ï¼ˆåŸæœ¬å°±æœ‰ï¼‰ -->
    <div id="checkContent"></div>

    <!-- ç³»çµ±æˆåŠŸè¾¨è­˜æ¸…å–® -->
    <div id="signerList" style="margin-top:16px;"></div>

    <hr style="margin:20px 0;">

    <!-- æ‰‹å‹•è£œç™» -->
    <h4>â• æ‰‹å‹•è£œç™»ç°½æ ¸äºº</h4>
    <div style="display:flex;gap:8px;">
      <input id="manualStaffId" placeholder="å“¡å·¥ç·¨è™Ÿ">
      <input id="manualName" placeholder="å§“åï¼ˆé¸å¡«ï¼‰">
      <button onclick="addManualSigner()">æ–°å¢</button>
    </div>

    <ul id="manualList" style="margin-top:10px;"></ul>

    <br>
<div style="display:flex;justify-content:flex-end;gap:12px;">
  <button class="secondary" onclick="cancelCreate()">å–æ¶ˆ</button>
  <button class="primary" onclick="confirmCreate()">å»ºç«‹ä»»å‹™</button>
</div>  </div>
</div>

<script>
let detectedSigners = [];
let manualSigners = [];
const createBtn = document.getElementById("createBtn");
  
/* ===== åˆ†é ç‹€æ…‹ ===== */
let signerPage = 1;
const SIGNERS_PER_PAGE = 10; // ğŸ”§ ä¸€é å¹¾å€‹äººï¼ˆ10 / 15 / 20 éƒ½å¯ä»¥ï¼‰
  
/* ===== å³æ™‚æ¬„ä½æª¢æŸ¥ ===== */
function validateForm(){
  const now = new Date();
  const m = month.value;
  const monthOK = m && new Date(m+"-01") >= new Date(now.getFullYear(),now.getMonth(),1);

  const ok =
    creator.value &&
    staffId.value &&
    unit.value &&
    monthOK &&
    password.value.length >= 6;

  createBtn.disabled = !ok;
}

["creator","staffId","unit","month","password"].forEach(id=>{
  document.getElementById(id).addEventListener("input",validateForm);
});

/* ===== æŸ¥æ ¸è¾¨è­˜ï¼ˆæ­£ç¢º async ç‰ˆæœ¬ï¼‰ ===== */
async function runCheck(){
  const modal = document.getElementById("modal");
  const content = document.getElementById("checkContent");

  const fileInput = document.querySelector('input[type="file"]');
  if (!fileInput.files.length) {
    alert("è«‹å…ˆä¸Šå‚³ç­è¡¨ Excel");
    return;
  }

  const fd = new FormData();
  fd.append("file", fileInput.files[0]);

  content.innerHTML = "â³ è¾¨è­˜ä¸­ï¼Œè«‹ç¨å€™â€¦";
  modal.style.display = "flex";

  try {
    const res = await fetch("https://chihwei-n8n.zeabur.app/webhook/roster-check", {
      method: "POST",
      body: fd
    });

    const data = await res.json();

    if (data.status !== "ok") {
      content.innerHTML = `
        <div class="status-bad">âŒ ${data.message || "æŸ¥æ ¸å¤±æ•—"}</div>
      `;
      createBtn.disabled = true;
      return;
    }

    detectedSigners = data.signers || [];
    manualSigners = [];

    content.innerHTML = `
      <div class="status-ok">âœ” æŸ¥æ ¸é€šé</div>
      ç³»çµ±è¾¨è­˜ç°½æ ¸äººæ•¸ï¼š${data.signerCount} äºº
    `;

    renderSignerList();
    createBtn.disabled = false;

  } catch (err) {
    content.innerHTML = `
      <div class="status-bad">âŒ ç³»çµ±éŒ¯èª¤</div>
      ç„¡æ³•é€£ç·šè‡³è¾¨è­˜æœå‹™
    `;
    createBtn.disabled = true;
  }
}

  function removeDetected(index){
  if (!confirm("ç¢ºå®šè¦ç§»é™¤æ­¤ç°½æ ¸äººï¼Ÿ")) return;
  detectedSigners.splice(index, 1);
  renderSignerList();
}
  function removeManual(index){
  manualSigners.splice(index, 1);
  renderManualList();
}
/* ===== é¡¯ç¤ºè¾¨è­˜æˆåŠŸæ¸…å–® ===== */
function renderSignerList(){
  const box = document.getElementById("signerList");

  const total = detectedSigners.length;
  const totalPages = Math.ceil(total / SIGNERS_PER_PAGE);
  if (signerPage > totalPages) signerPage = totalPages || 1;

  const start = (signerPage - 1) * SIGNERS_PER_PAGE;
  const end = start + SIGNERS_PER_PAGE;
  const pageData = detectedSigners.slice(start, end);

  let html = `
    <h4>ğŸ“‹ å·²è¾¨è­˜ç°½æ ¸äººï¼ˆ${total} äººï¼‰</h4>

<div style="max-height:420px;overflow:auto;border:1px solid #e5e7eb;border-radius:8px;">      <table style="width:100%;font-size:14px;">
        <tr>
          <th style="padding:6px;">å“¡å·¥ç·¨è™Ÿ</th>
          <th style="padding:6px;">å§“å</th>
          <th style="width:40px;"></th>
        </tr>
  `;

  pageData.forEach((s,idx)=>{
    const realIndex = start + idx; // âš ï¸ é—œéµï¼šå°æ‡‰åŸé™£åˆ—
    html += `
      <tr>
        <td style="padding:6px;">${s.staffId}</td>
        <td style="padding:6px;">${s.name || "-"}</td>
        <td style="padding:6px;">
          <button onclick="removeDetected(${realIndex})"
            style="border:none;background:none;color:#b91c1c;cursor:pointer;">
            âœ–
          </button>
        </td>
      </tr>
    `;
  });

  html += `
      </table>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
      <button ${signerPage===1?"disabled":""}
        onclick="changeSignerPage(-1)">â—€ ä¸Šä¸€é </button>

      <span>ç¬¬ ${signerPage} / ${totalPages || 1} é </span>

      <button ${signerPage===totalPages?"disabled":""}
        onclick="changeSignerPage(1)">ä¸‹ä¸€é  â–¶</button>
    </div>
  `;

  box.innerHTML = html;
}

  function changeSignerPage(delta){
  signerPage += delta;
  if (signerPage < 1) signerPage = 1;
  renderSignerList();
}
  
/* ===== æ‰‹å‹•è£œç™» ===== */
function addManualSigner(){
  const id = manualStaffId.value.trim();
  const name = manualName.value.trim();

  if (!id) {
    alert("å“¡å·¥ç·¨è™Ÿå¿…å¡«");
    return;
  }

  if (
    detectedSigners.some(s=>s.staffId===id) ||
    manualSigners.some(s=>s.staffId===id)
  ) {
    alert("æ­¤å“¡å·¥ç·¨è™Ÿå·²å­˜åœ¨");
    return;
  }

  manualSigners.push({ staffId:id, name });
  manualStaffId.value="";
  manualName.value="";

  renderManualList();
}

function renderManualList(){
  const ul = document.getElementById("manualList");
  ul.innerHTML = "";

  manualSigners.forEach((s,idx)=>{
    const li = document.createElement("li");
    li.style.display="flex";
    li.style.justifyContent="space-between";
    li.style.alignItems="center";
    li.style.marginBottom="6px";

    li.innerHTML = `
      <span>${s.staffId} ${s.name || ""}</span>
      <button onclick="removeManual(${idx})" style="border:none;background:none;color:#b91c1c;cursor:pointer;">âœ–</button>
    `;
    ul.appendChild(li);
  });
}

/* ===== å»ºç«‹ä»»å‹™ï¼ˆDemoï¼‰ ===== */
function confirmCreate(){
  createBtn.textContent="è™•ç†ä¸­â€¦";
  createBtn.disabled=true;

  setTimeout(()=>{
    createBtn.textContent="å·²å»ºç«‹";
    alert("ï¼ˆDemoï¼‰ä»»å‹™å»ºç«‹å®Œæˆ");
    document.getElementById("modal").style.display="none";
  },1200);
}

/* ===== è¤‡è£½é€£çµ ===== */
function copyLink(){
  alert("ï¼ˆDemoï¼‰ä»»å‹™é€£çµå·²è¤‡è£½");
}

  function cancelCreate(){
  if (!confirm("ç¢ºå®šè¦å–æ¶ˆå»ºç«‹ä»»å‹™ï¼Ÿ")) return;
  document.getElementById("modal").style.display = "none";
}
const fileInput = document.getElementById("fileInput");
const fileName = document.getElementById("fileName");
const clearFileBtn = document.getElementById("clearFileBtn");

fileInput.addEventListener("change", () => {
  if (fileInput.files.length) {
    fileName.textContent = fileInput.files[0].name;
    clearFileBtn.style.display = "inline";
  }
});

function clearFile(){
  fileInput.value = "";
  fileName.textContent = "";
  clearFileBtn.style.display = "none";
}
</script>

</body>
</html>
