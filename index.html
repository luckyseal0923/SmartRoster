<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>SmartRosterï½œæ™ºæ…§ç­è¡¨ç°½æ ¸ç³»çµ±</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root{
  --primary:#374151;      /* çŸ³å¢¨ç° */
  --accent:#059669;       /* é†«ç™‚ç¶  */
  --bg:#eef2f0;           /* æ·¡èƒŒæ™¯ */
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --ok:#059669;
  --warn:#b45309;
  --bad:#b91c1c;
}

body{
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC",sans-serif;
  background:var(--bg);
  color:var(--text);
  margin:0;
  padding:32px;
}

.container{max-width:1200px;margin:auto;}

header{margin-bottom:32px;}
header h1{margin:0;font-size:30px;}
header p{margin-top:6px;color:var(--muted);}

.card{
  background:var(--card);
  border-radius:16px;
  padding:28px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
  margin-bottom:32px;
}

h3{margin-top:0;}

/* ===== è¡¨å–® ===== */
.form-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px 20px;
}

label{
  font-size:13px;
  color:var(--muted);
  margin-bottom:4px;
  display:block;
}

input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:14px;
}

.upload-box{
  margin-top:16px;
  border:2px dashed var(--border);
  border-radius:14px;
  padding:24px;
  text-align:center;
  background:#fafafa;
}

/* ===== æŒ‰éˆ• ===== */
.actions{
  display:flex;
  gap:16px;
  margin-top:24px;
}

button{
  padding:14px 20px;
  border-radius:12px;
  border:none;
  font-size:15px;
  cursor:pointer;
}

button.primary{background:var(--primary);color:#fff;}
button.accent{background:var(--accent);color:#fff;}
button:disabled{opacity:.5;cursor:not-allowed;}
  button.secondary{
  background:#f3f4f6;
  color:#374151;
  border:1px solid #d1d5db;
}

button.secondary:hover{
  background:#e5e7eb;
}

/* ===== ä»»å‹™æ¸…å–® table ===== */
table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:14px 12px;
  border-bottom:1px solid var(--border);
  font-size:14px;
  text-align:left;
}

th{color:var(--muted);font-weight:600;}

.progress{
  background:#e5e7eb;
  border-radius:999px;
  height:10px;
  overflow:hidden;
  margin-bottom:6px;
}

.progress-bar{
  background:var(--accent);
  height:100%;
}

.copy{cursor:pointer;font-size:18px;}

/* ===== Modal ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
}

.modal-box{
  background:#fff;
  border-radius:16px;
  padding:28px;
  width:440px;
  max-height:85vh;        /* âœ… æ–°å¢ */
  overflow:hidden;        /* âœ… æ–°å¢ */
}

.status-ok{color:var(--ok);}
.status-warn{color:var(--warn);}
.status-bad{color:var(--bad);
           }
  .file-btn{
  padding:10px 14px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#f9fafb;
  cursor:pointer;
  font-size:14px;
}

.file-btn:hover{
  background:#eef2f7;
}
</style>
</head>

<body>
<div class="container">

<header>
  <h1>SmartRoster</h1>
  <p>æ™ºæ…§ç­è¡¨ç°½æ ¸ç³»çµ±</p>
</header>

<!-- ===== å»ºç«‹æ–°ä»»å‹™ ===== -->
<div class="card">
  <h3>ğŸ“Œ å»ºç«‹æ–°ç°½æ ¸ä»»å‹™</h3>

  <div class="form-grid">
    <div>
      <label>ä»»å‹™å»ºç«‹è€…</label>
      <input id="creator">
    </div>

    <div>
      <label>å“¡å·¥ç·¨è™Ÿ</label>
      <input id="staffId">
    </div>

    <div>
      <label>å–®ä½åˆ¥</label>
      <input id="unit">
    </div>

    <div>
      <label>ç°½æ ¸æœˆä»½</label>
      <input id="month" type="month">
    </div>

    <div>
      <label>è¨­å®šå¯†ç¢¼ï¼ˆè‡³å°‘ 6 ç¢¼ï¼‰</label>
      <input id="password" type="password">
    </div>
  </div>

<div class="upload-box">
  <div style="font-size:18px;margin-bottom:8px;">
    ğŸ“ <strong>ä¸Šå‚³ç­è¡¨ Excel</strong>
  </div>

  <p style="color:var(--muted);margin-bottom:12px;">
    ç”¨æ–¼è¾¨è­˜å¾…ç°½æ ¸äººæ•¸
  </p>

  <div id="filePicker" style="display:flex;align-items:center;gap:10px;">
    <label for="fileInput" class="file-btn">
      â¬† é¸æ“‡æª”æ¡ˆ
    </label>
    <span id="fileName" style="color:#374151;"></span>
    <button id="clearFileBtn"
            onclick="clearFile()"
            style="display:none;border:none;background:none;color:#b91c1c;cursor:pointer;font-size:18px;">
      âœ–
    </button>
  </div>

  <input id="fileInput" type="file" accept=".xlsx,.xls" style="display:none;">
</div>

  <div class="actions">
    <button class="accent" onclick="runCheck()">ğŸ” æŸ¥æ ¸ä»»å‹™è¾¨è­˜</button>
  </div>
</div>

<!-- ===== ä»»å‹™æ¸…å–®ï¼ˆèˆŠåŠŸèƒ½å®Œæ•´ä¿ç•™ï¼‰ ===== -->
<div class="card">
  <h3>ğŸ“Š ä»»å‹™æ¸…å–®</h3>

  <table>
    <thead>
      <tr>
        <th>ä»»å‹™ç·¨ç¢¼</th>
        <th>å–®ä½</th>
        <th>æœˆä»½</th>
        <th>å®Œæˆåº¦</th>
        <th>é€£çµ</th>
      </tr>
    </thead>
<tbody id="taskTableBody">
      <tr><td colspan="5" style="text-align:center;">è¼‰å…¥ä¸­...</td></tr>
    </tbody>
  </table>
</div>

</div>

<!-- ===== æŸ¥æ ¸ Modalï¼ˆDemoï¼‰ ===== -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3>ğŸ” ä»»å‹™è¾¨è­˜çµæœ</h3>

    <!-- ç³»çµ±æŸ¥æ ¸ç‹€æ…‹ï¼ˆåŸæœ¬å°±æœ‰ï¼‰ -->
    <div id="checkContent"></div>

    <!-- ç³»çµ±æˆåŠŸè¾¨è­˜æ¸…å–® -->
    <div id="signerList" style="margin-top:16px;"></div>

    <hr style="margin:20px 0;">

    <!-- æ‰‹å‹•è£œç™» -->
    <h4>â• æ‰‹å‹•è£œç™»ç°½æ ¸äºº</h4>
    <div style="display:flex;gap:8px;">
      <input id="manualStaffId" placeholder="å“¡å·¥ç·¨è™Ÿ">
      <input id="manualName" placeholder="å§“åï¼ˆé¸å¡«ï¼‰">
      <button onclick="addManualSigner()">æ–°å¢</button>
    </div>

    <ul id="manualList" style="margin-top:10px;"></ul>

    <br>
<div style="display:flex;justify-content:flex-end;gap:12px;">
  <button class="secondary" onclick="cancelCreate()">å–æ¶ˆ</button>
<button id="createBtn"
        class="primary"
        onclick="confirmCreate()">
  å»ºç«‹ä»»å‹™
</button></div>  </div>
</div>

<script>
  /* ===== DOM å…ƒç´ å¿«å–ï¼ˆä¸€å®šè¦æœ‰ï¼‰ ===== */
const creator = document.getElementById("creator");
const staffId = document.getElementById("staffId");
const unit = document.getElementById("unit");
const month = document.getElementById("month");
const password = document.getElementById("password");

const manualStaffId = document.getElementById("manualStaffId");
const manualName = document.getElementById("manualName");

const fileInput = document.getElementById("fileInput");
const fileName = document.getElementById("fileName");
const clearFileBtn = document.getElementById("clearFileBtn");

const createBtn = document.getElementById("createBtn");
let detectedSigners = [];
let manualSigners = [];
  
/* ===== åˆ†é ç‹€æ…‹ ===== */
let signerPage = 1;
const SIGNERS_PER_PAGE = 10; // ğŸ”§ ä¸€é å¹¾å€‹äººï¼ˆ10 / 15 / 20 éƒ½å¯ä»¥ï¼‰
  
/* ===== å³æ™‚æ¬„ä½æª¢æŸ¥ ===== */
function validateForm(){
  const now = new Date();
  const m = month.value;
  const monthOK = m && new Date(m+"-01") >= new Date(now.getFullYear(),now.getMonth(),1);

  const ok =
    creator.value &&
    staffId.value &&
    unit.value &&
    monthOK &&
    password.value.length >= 6;

  createBtn.disabled = !ok;
}

["creator","staffId","unit","month","password"].forEach(id=>{
  document.getElementById(id).addEventListener("input",validateForm);
});

/* ===== æŸ¥æ ¸è¾¨è­˜ï¼ˆæ­£ç¢º async ç‰ˆæœ¬ï¼‰ ===== */
async function runCheck(){
  const modal = document.getElementById("modal");
  const content = document.getElementById("checkContent");

  if (!fileInput.files.length) {
    alert("è«‹å…ˆä¸Šå‚³ç­è¡¨ Excel");
    return;
  }

  const fd = new FormData();
  fd.append("file", fileInput.files[0]);

  content.innerHTML = "â³ è¾¨è­˜ä¸­ï¼Œè«‹ç¨å€™â€¦";
  modal.style.display = "flex";

  try {
    const res = await fetch(
      "https://chihwei-n8n.zeabur.app/webhook/roster-check",
      { method: "POST", body: fd }
    );

    /* âœ… å…ˆæ‹¿åŸå§‹æ–‡å­—ï¼ˆé—œéµï¼‰ */
    const text = await res.text();
    let data;

    try {
      data = JSON.parse(text);
    } catch (e) {
      console.error("âš ï¸ é JSON å›å‚³ï¼š", text);
      throw new Error("å¾Œç«¯å›å‚³æ ¼å¼éŒ¯èª¤");
    }

    /* âœ… å†ä¾†æ‰åˆ¤æ–·å…§å®¹ */
    if (!res.ok || data.status !== "ok") {
      content.innerHTML = `
        <div class="status-bad">
          âŒ ${data.message || "æŸ¥æ ¸å¤±æ•—"}
        </div>
      `;
      return;
    }

    detectedSigners = data.signers || [];
    manualSigners = [];
    signerPage = 1;

    content.innerHTML = `
      <div class="status-ok">âœ” æŸ¥æ ¸é€šé</div>
      ç³»çµ±è¾¨è­˜ç°½æ ¸äººæ•¸ï¼š${detectedSigners.length} äºº
    `;

    renderSignerList();

  } catch (err) {
    console.error(err);
    content.innerHTML = `
      <div class="status-bad">
        âŒ ç³»çµ±éŒ¯èª¤<br>
        ${err.message || "ç„¡æ³•é€£ç·šè‡³è¾¨è­˜æœå‹™"}
      </div>
    `;
  }
}

  function removeDetected(index){
  if (!confirm("ç¢ºå®šè¦ç§»é™¤æ­¤ç°½æ ¸äººï¼Ÿ")) return;
  detectedSigners.splice(index, 1);
  renderSignerList();
}
  function removeManual(index){
  manualSigners.splice(index, 1);
  renderManualList();
}
/* ===== é¡¯ç¤ºè¾¨è­˜æˆåŠŸæ¸…å–® ===== */
function renderSignerList(){
  const box = document.getElementById("signerList");

  const total = detectedSigners.length;
  const totalPages = Math.ceil(total / SIGNERS_PER_PAGE);
  if (signerPage > totalPages) signerPage = totalPages || 1;

  const start = (signerPage - 1) * SIGNERS_PER_PAGE;
  const end = start + SIGNERS_PER_PAGE;
  const pageData = detectedSigners.slice(start, end);

  let html = `
    <h4>ğŸ“‹ å·²è¾¨è­˜ç°½æ ¸äººï¼ˆ${total} äººï¼‰</h4>

<div style="max-height:420px;overflow:auto;border:1px solid #e5e7eb;border-radius:8px;">      <table style="width:100%;font-size:14px;">
        <tr>
          <th style="padding:6px;">å“¡å·¥ç·¨è™Ÿ</th>
          <th style="padding:6px;">å§“å</th>
          <th style="width:40px;"></th>
        </tr>
  `;

  pageData.forEach((s,idx)=>{
    const realIndex = start + idx; // âš ï¸ é—œéµï¼šå°æ‡‰åŸé™£åˆ—
    html += `
      <tr>
        <td style="padding:6px;">${s.staffId}</td>
        <td style="padding:6px;">${s.name || "-"}</td>
        <td style="padding:6px;">
          <button onclick="removeDetected(${realIndex})"
            style="border:none;background:none;color:#b91c1c;cursor:pointer;">
            âœ–
          </button>
        </td>
      </tr>
    `;
  });

  html += `
      </table>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
      <button ${signerPage===1?"disabled":""}
        onclick="changeSignerPage(-1)">â—€ ä¸Šä¸€é </button>

      <span>ç¬¬ ${signerPage} / ${totalPages || 1} é </span>

      <button ${signerPage===totalPages?"disabled":""}
        onclick="changeSignerPage(1)">ä¸‹ä¸€é  â–¶</button>
    </div>
  `;

  box.innerHTML = html;
}

  function changeSignerPage(delta){
  signerPage += delta;
  if (signerPage < 1) signerPage = 1;
  renderSignerList();
}
  
/* ===== æ‰‹å‹•è£œç™» ===== */
function addManualSigner(){
  const id = manualStaffId.value.trim();
  const name = manualName.value.trim();

  if (!id) {
    alert("å“¡å·¥ç·¨è™Ÿå¿…å¡«");
    return;
  }

  if (
    detectedSigners.some(s=>s.staffId===id) ||
    manualSigners.some(s=>s.staffId===id)
  ) {
    alert("æ­¤å“¡å·¥ç·¨è™Ÿå·²å­˜åœ¨");
    return;
  }

  manualSigners.push({ staffId:id, name });
  manualStaffId.value="";
  manualName.value="";

  renderManualList();
}

function renderManualList(){
  const ul = document.getElementById("manualList");
  ul.innerHTML = "";

  manualSigners.forEach((s,idx)=>{
    const li = document.createElement("li");
    li.style.display="flex";
    li.style.justifyContent="space-between";
    li.style.alignItems="center";
    li.style.marginBottom="6px";

    li.innerHTML = `
      <span>${s.staffId} ${s.name || ""}</span>
      <button onclick="removeManual(${idx})" style="border:none;background:none;color:#b91c1c;cursor:pointer;">âœ–</button>
    `;
    ul.appendChild(li);
  });
}

/* ===== å»ºç«‹ä»»å‹™ï¼ˆæ­£å¼ç‰ˆï¼Œå‘¼å« roster-createï¼‰ ===== */
async function confirmCreate(){

  if (!fileInput.files.length) {
    alert("æ‰¾ä¸åˆ°åŸå§‹ Excel æª”æ¡ˆ");
    return;
  }

  createBtn.textContent = "å»ºç«‹ä¸­â€¦";
  createBtn.disabled = true;

  try {
    const fd = new FormData();

    // ===== åŸºæœ¬ä»»å‹™è³‡æ–™ =====
    fd.append("creator", creator.value);
    fd.append("creator_staff_id", staffId.value);
    fd.append("unit", unit.value);
    fd.append("sign_month", month.value);
    fd.append("password", password.value);

    // ===== ç°½æ ¸äººè³‡æ–™ =====
    fd.append("detected_signers", JSON.stringify(detectedSigners));
    fd.append("manual_signers", JSON.stringify(manualSigners));

    // ===== Excel åŸå§‹æª” =====
    fd.append("file", fileInput.files[0]);

    const res = await fetch(
      "https://chihwei-n8n.zeabur.app/webhook/roster-create",
      {
        method: "POST",
        body: fd
      }
    );

    // âœ… é˜²å‘†ï¼šå…ˆè®€ text
    const text = await res.text();
    let data;

    try {
      data = JSON.parse(text);
    } catch (e) {
      console.error("âš ï¸ é JSON å›å‚³ï¼š", text);
      throw new Error("å¾Œç«¯å›å‚³æ ¼å¼éŒ¯èª¤");
    }

    if (!res.ok || data.status !== "ok") {
      throw new Error(data.message || "ä»»å‹™å»ºç«‹å¤±æ•—");
    }

    alert(`âœ… ä»»å‹™å»ºç«‹å®Œæˆ\nä»»å‹™ç·¨ç¢¼ï¼š${data.task_id}`);

    // ğŸ“ åœ¨é€™è£¡åŠ å…¥é€™ä¸€è¡Œ
fetchTasks();

    // é—œé–‰ Modal
    document.getElementById("modal").style.display = "none";

    // ï¼ˆå¯é¸ï¼‰ä¹‹å¾Œé€™è£¡å¯ä»¥ reload ä»»å‹™æ¸…å–®
    // location.reload();

  } catch (err) {
    console.error(err);
    alert(`âŒ å»ºç«‹ä»»å‹™å¤±æ•—\n${err.message || "ç³»çµ±éŒ¯èª¤"}`);
  } finally {
    createBtn.textContent = "å»ºç«‹ä»»å‹™";
    createBtn.disabled = false;
  }
}

/* ===== è¤‡è£½é€£çµ ===== */
function copyLink(){
  alert("ï¼ˆDemoï¼‰ä»»å‹™é€£çµå·²è¤‡è£½");
}

  function cancelCreate(){
  if (!confirm("ç¢ºå®šè¦å–æ¶ˆå»ºç«‹ä»»å‹™ï¼Ÿ")) return;
  document.getElementById("modal").style.display = "none";
}

fileInput.addEventListener("change", () => {
  if (fileInput.files.length) {
    fileName.textContent = fileInput.files[0].name;
    clearFileBtn.style.display = "inline";
  }
});
  
function clearFile(){
  fileInput.value = "";
  fileName.textContent = "";
  clearFileBtn.style.display = "none";
}

  // åœ¨é é¢è¼‰å…¥å¾Œè‡ªå‹•åŸ·è¡Œ
window.addEventListener('DOMContentLoaded', fetchTasks);

async function fetchTasks() {
  const tbody = document.getElementById("taskTableBody");
  
  try {
    // ğŸ”— è«‹æ›¿æ›æˆæ‚¨åœ¨ n8n å»ºç«‹çš„ GET Webhook URL
    const res = await fetch("https://chihwei-n8n.zeabur.app/webhook/roster-list");
    const tasks = await res.json();

    if (!tasks || tasks.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ç›®å‰ç„¡ä»»å‹™</td></tr>';
      return;
    }

    tbody.innerHTML = ""; // æ¸…ç©ºè¼‰å…¥ä¸­æ–‡å­—

    tasks.forEach(task => {
      // è¨ˆç®—é€²åº¦ç™¾åˆ†æ¯” (å‡è¨­å¾Œç«¯å·²ç®—å¥½ï¼Œæˆ–æ˜¯å‰ç«¯ç®—)
      // é€™è£¡å‡è¨­å¾Œç«¯å›å‚³åŒ…å« progress æ¬„ä½
      const progress = task.progress || 0; 
      
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${task.task_id}</td>
        <td>${task.unit}</td>
        <td>${task.month}</td>
        <td>
          <div class="progress">
            <div class="progress-bar" style="width:${progress}%"></div>
          </div>
          ${progress}% (${task.signed_count || 0}/${task.signer_count})
        </td>
        <td>
          <span class="copy" onclick="copyLink('${task.task_id}')" title="è¤‡è£½ç°½æ ¸é€£çµ">ğŸ“‹</span>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error("è¼‰å…¥ä»»å‹™æ¸…å–®å¤±æ•—:", err);
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">ç„¡æ³•è¼‰å…¥è³‡æ–™</td></tr>';
  }
}

// ä¿®æ­£å¾Œçš„è¤‡è£½é€£çµåŠŸèƒ½
function copyLink(taskId) {
  // é€™è£¡å¯ä»¥å®šç¾©ç°½æ ¸é é¢çš„ URL æ ¼å¼
  const signUrl = `${window.location.origin}/sign.html?id=${taskId}`;
  navigator.clipboard.writeText(signUrl).then(() => {
    alert(`ä»»å‹™ ${taskId} é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼`);
  });
}
  
</script>

</body>
</html>
